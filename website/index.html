
<!DOCTYPE html>
<html>
<head>
    <title>(Almost) Real-time Wifi-Client Heatmap</title>
    <style>
        body { height: 100%; width: 100%;
               padding: 0; margin: 0;}
        canvas { padding: 0; margin: 0;
                 position: absolute; left: 0; top: 0;}
        img { max-width: 100%; max-height: 100%;
              position: absolute; left: 0; top: 0;}
    </style>
</head>
<body>
    <img id="floor" src="floorplan.png">
    <canvas id="canvas"></canvas>
</div>
<script src="jquery-3.1.1.min.js"></script>
<script src="simpleheat.js"></script>
<script>

window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                               window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

function get(id) {
    return document.getElementById(id);
}

canvas = get('canvas');
canvas.height = get('floor').height
canvas.width = get('floor').width

// TODO resize with browser

var heat = simpleheat('canvas');
heat.max(18);
heat.radius(30, 60); // radius, blur
heat.gradient(heat.defaultGradient);

var ap_list, ap_loc;

function fill_data() {
    for(var i=0; i < ap_list.length; i++) {
        if(ap_list[i]["name"] in ap_loc) {
            loc = ap_loc[ap_list[i]["name"]];
            heat.add([loc[0]*get('floor').width, loc[1]*get('floor').height, ap_list[i]["clients"]]);
        } else {
            console.log('Unknown location for '+ap_list[i]["name"])
        }
    }
}

function draw() {
    console.time('draw');
    heat.draw();
    console.timeEnd('draw');
}

$.getJSON("ap_list.json", function( data ) {
    ap_list = data;
    if(ap_loc) {
        fill_data();
        draw();
    }
});
$.getJSON("ap_loc.json", function( data ) {
    ap_loc = data;
    if(ap_list) {
        fill_data();
        draw();
    }
});

//setInterval(function(){ draw(); }, 300);

</script>
</body>
</html>
